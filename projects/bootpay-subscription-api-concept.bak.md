# 부트페이 구독 서비스 API 설계 컨셉

> 사업자는 SDK 한 줄 호출로 구독 시작, 나머지는 부트페이가 알아서 처리

---

## 1. 핵심 원칙

| 구분 | 사업자 | 부트페이 |
|-----|-------|---------|
| 구독 시작 | SDK 1회 호출 | 카드등록 + 결제 + 구독생성 |
| 정기 결제 | 없음 | 자동 실행 |
| 실패 처리 | 없음 | 자동 재시도 |
| 구독 해지 | SDK 1회 호출 | 처리 |
| 이벤트 알림 | Webhook 수신 | 자동 전송 |

---

## 2. 사업자 작업 흐름

### Step 1: 관리자에서 사전 설정 (1회)

| 설정 항목 | 설명 |
|----------|-----|
| 구독 플랜 생성 | plan_id 발급 |
| 가격/주기 설정 | 월간, 연간, 커스텀 |
| 무료체험 설정 | 7일, 14일, 30일 등 |
| Webhook URL 등록 | 이벤트 수신 엔드포인트 |
| 결제 정책 | 재시도 횟수, 알림 설정 |

### Step 2: SDK 호출 방식 선택

| 방법 | 사용 시점 | 흐름 |
|-----|----------|-----|
| **A. 기본** | 고정 가격 플랜 | SDK 호출 → 완료 |
| **B. 고급** | 할인/쿠폰/동적 가격 | API 호출 → SDK 호출 → 완료 |

#### 방법 선택 기준

| 상황 | 방법 |
|-----|-----|
| 고정 가격 플랜 | A (SDK만) |
| 쿠폰/할인 적용 | B (API → SDK) |
| 프로모션 캠페인 | B (API → SDK) |
| 커스텀 무료체험 | B (API → SDK) |
| 사용자별 동적 가격 | B (API → SDK) |

---

## 3. SDK 메서드

### 필수

| 메서드 | 용도 | 입력 |
|-------|-----|-----|
| `subscribe()` | 구독 시작 | plan_id + user 또는 session_id |
| `cancel()` | 구독 해지 | subscription_id |

### 선택

| 메서드 | 용도 |
|-------|-----|
| `changePlan()` | 플랜 변경 |
| `updatePaymentMethod()` | 결제수단 변경 |
| `pause()` | 일시정지 |
| `resume()` | 재개 |
| `getSubscription()` | 상태 조회 |

---

## 4. API 메서드 (옵셔널)

| 메서드 | 용도 | 언제 사용 |
|-------|-----|----------|
| `POST /session` | 구독 세션 생성 | 할인/쿠폰 적용 시 |

### 세션 생성 시 설정 가능 항목

| 파라미터 | 설명 |
|---------|-----|
| plan_id | 플랜 ID |
| user_id | 사용자 ID |
| coupon_code | 쿠폰 코드 |
| discount_amount | 할인 금액 |
| trial_days | 무료체험 일수 오버라이드 |
| metadata | 추가 메타데이터 |

---

## 5. 부트페이 자동 처리

### SDK 호출 시 (즉시)

```
SDK 호출
   │
   ├─→ 결제창 팝업 표시
   │
   ├─→ 카드 정보 수집
   │
   ├─→ 빌링키 발급 (지갑 저장)
   │
   ├─→ 첫 결제 실행
   │
   ├─→ 구독 생성
   │
   └─→ 결과 반환 (subscription_id)
```

### 이후 자동 처리

| 시점 | 동작 | Webhook 이벤트 |
|-----|-----|---------------|
| 매월 결제일 | 자동 결제 | `payment.success` |
| 결제 실패 | 재시도 예약 | `payment.failed` |
| 재시도 실행 | 자동 재결제 | `payment.retry` |
| 재시도 모두 실패 | 구독 일시정지 | `subscription.suspended` |
| 카드 만료 D-30 | 만료 알림 | `billing_key.expiring` |
| 결제 D-3 | 예정 알림 | `payment.upcoming` |
| 구독 기간 종료 | 만료 처리 | `subscription.expired` |

---

## 6. 전체 흐름도

### 방법 A: 기본 흐름 (SDK만)

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   사업자    │     │  부트페이   │     │   사업자    │
│  웹사이트   │     │    SDK      │     │   서버      │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │
       │  subscribe()      │                   │
       │──────────────────→│                   │
       │                   │                   │
       │                   │ ┌───────────────┐ │
       │                   │ │ 1. 결제창     │ │
       │                   │ │ 2. 카드등록   │ │
       │                   │ │ 3. 첫 결제    │ │
       │                   │ │ 4. 구독생성   │ │
       │                   │ └───────────────┘ │
       │                   │                   │
       │   결과 반환       │                   │
       │←──────────────────│                   │
       │                   │                   │
       │                   │   Webhook 전송    │
       │                   │──────────────────→│
       │                   │                   │
```

### 방법 B: 고급 흐름 (API → SDK)

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   사업자    │     │   사업자    │     │  부트페이   │
│  웹사이트   │     │   서버      │     │   API/SDK   │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │
       │  구독 요청        │                   │
       │  (쿠폰 포함)      │                   │
       │──────────────────→│                   │
       │                   │                   │
       │                   │  POST /session    │
       │                   │  (할인/쿠폰 적용) │
       │                   │──────────────────→│
       │                   │                   │
       │                   │   session_id      │
       │                   │←──────────────────│
       │                   │                   │
       │   session_id      │                   │
       │←──────────────────│                   │
       │                   │                   │
       │  subscribe(session_id)                │
       │──────────────────────────────────────→│
       │                   │                   │
       │                   │ ┌───────────────┐ │
       │                   │ │ 할인 적용된   │ │
       │                   │ │ 금액으로 결제 │ │
       │                   │ └───────────────┘ │
       │                   │                   │
       │   결과 반환       │                   │
       │←──────────────────────────────────────│
       │                   │                   │
```

### 정기 결제 흐름 (자동)

```
┌─────────────┐                         ┌─────────────┐
│  부트페이   │                         │   사업자    │
│   서버      │                         │   서버      │
└──────┬──────┘                         └──────┬──────┘
       │                                       │
       │  [매월 결제일]                        │
       │                                       │
       ├─ 결제 시도                            │
       │                                       │
       ├─ 성공 ────→ Webhook: payment.success ─────→│
       │                                       │    권한 유지
       │                                       │
       ├─ 실패 ────→ Webhook: payment.failed ──────→│
       │                                       │    사용자 알림
       │                                       │
       ├─ [3일 후 재시도]                      │
       │                                       │
       ├─ 성공 ────→ Webhook: payment.retry ───────→│
       │            (success)                  │    권한 유지
       │                                       │
       ├─ 3회 실패 → Webhook: subscription.suspended→│
       │                                       │    권한 일시정지
       │                                       │
```

---

## 7. Webhook 이벤트 처리

| 이벤트 | 사업자 처리 |
|-------|-----------|
| `payment.success` | 서비스 권한 유지/부여 |
| `payment.failed` | 사용자에게 결제 실패 안내 |
| `payment.retry` | 재시도 결과에 따라 처리 |
| `subscription.suspended` | 서비스 일시정지 |
| `subscription.expired` | 서비스 권한 회수 |
| `billing_key.expiring` | 카드 재등록 안내 |
| `payment.upcoming` | 결제 예정 안내 (선택) |

---

## 8. 사업자 구현 체크리스트

### 필수

| 항목 | 설명 |
|-----|-----|
| SDK 스크립트 삽입 | HTML에 스크립트 태그 추가 |
| subscribe() 호출 | 구독 시작 버튼 연결 |
| Webhook 엔드포인트 | 이벤트 수신 서버 구현 |
| 권한 관리 로직 | 결제 상태에 따른 접근 제어 |

### 선택

| 항목 | 설명 |
|-----|-----|
| cancel() 호출 | 해지 버튼 |
| 세션 API 연동 | 할인/쿠폰 적용 시 |
| changePlan() | 플랜 변경 UI |
| updatePaymentMethod() | 결제수단 변경 UI |
| 구독 현황 페이지 | 상태 조회 UI |

---

## 9. 최종 요약

### 호출 횟수

| 상황 | SDK | API | 합계 |
|-----|-----|-----|-----|
| 신규 구독 (기본) | 1 | 0 | 1 |
| 신규 구독 (할인) | 1 | 1 | 2 |
| 정기 결제 | 0 | 0 | 0 |
| 플랜 변경 | 1 | 0 | 1 |
| 해지 | 1 | 0 | 1 |

### 책임 분리

```
┌─────────────────────────────────────────────────────────┐
│                      사업자                              │
├─────────────────────────────────────────────────────────┤
│  • SDK 호출 (시작/해지)                                  │
│  • Webhook 수신 → 권한 관리                              │
│  • (선택) 세션 API 호출 (할인/쿠폰)                      │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                      부트페이                            │
├─────────────────────────────────────────────────────────┤
│  • 결제 UI 제공                                          │
│  • 카드 등록 (빌링키)                                    │
│  • 첫 결제 실행                                          │
│  • 구독 생성/관리                                        │
│  • 정기 결제 자동 실행                                   │
│  • 실패 시 재시도                                        │
│  • 만료/예정 알림                                        │
│  • Webhook 전송                                          │
└─────────────────────────────────────────────────────────┘
```
