# 부트페이 Invoice API 연동 가이드

> 할인/프로모션 적용 시 **서버 API → SDK** 흐름으로 위변조 방지

---

## 1. 왜 서버 API를 써야 하나?

### 클라이언트 SDK 직접 호출의 문제

```
사용자 브라우저에서 할인 파라미터 조작 가능
   │
   ├─ discount_percent: 20 → 90 으로 변경
   ├─ setup_fee: 500 → 0 으로 변경
   └─ price: 10000 → 100 으로 변경
```

| 방식 | 할인/가격 파라미터 | 위변조 가능성 |
|-----|-----------------|-------------|
| 클라이언트 SDK 직접 | 브라우저에서 전송 | **위험** |
| 서버 API → SDK | 서버에서 전송 | **안전** |

### 결론

| 상황 | 권장 방식 |
|-----|----------|
| 고정 가격 (할인 없음) | SDK 직접 호출 가능 |
| 할인/프로모션/동적 가격 | **서버 API → SDK 필수** |

---

## 2. 핵심 원리: request_id 매칭

```
┌─────────────┐                         ┌─────────────┐
│  사업자 서버 │                         │   부트페이   │
└──────┬──────┘                         └──────┬──────┘
       │                                       │
       │ ① POST /v1/invoices                   │
       │   { request_id: "abc123",             │
       │     price_adjustments: [...] }        │
       │──────────────────────────────────────→│
       │                                       │
       │ ② 청구서 생성 완료                     │
       │←──────────────────────────────────────│
       │                                       │


┌─────────────┐                         ┌─────────────┐
│  클라이언트  │                         │   부트페이   │
└──────┬──────┘                         └──────┬──────┘
       │                                       │
       │ ③ SDK 호출                            │
       │   requestInvoice({                    │
       │     request_id: "abc123"  ← 동일한 ID │
       │   })                                  │
       │──────────────────────────────────────→│
       │                                       │
       │         ┌─────────────────────────────────────┐
       │         │ request_id로 청구서 조회            │
       │         │ → 서버에서 설정한 할인 적용된 결제   │
       │         └─────────────────────────────────────┘
       │                                       │
       │ ④ 결제 결과 반환                       │
       │←──────────────────────────────────────│
       │                                       │


┌─────────────┐                         ┌─────────────┐
│  사업자 서버 │                         │   부트페이   │
└──────┬──────┘                         └──────┬──────┘
       │                                       │
       │ ⑤ Webhook 전송                        │
       │←──────────────────────────────────────│
       │                                       │
```

### 핵심

| 항목 | 설명 |
|-----|-----|
| 서버 API | `request_id` + 할인 파라미터로 청구서 생성 |
| 클라이언트 SDK | **동일한 `request_id`**로 호출 |
| 부트페이 | `request_id`로 매칭 → 할인 적용된 청구서로 결제 |

---

## 3. 단계별 구현

### Step 1: 사업자 서버 → 부트페이 API

서버에서 **할인 파라미터 포함**하여 청구서 생성

#### 요청

| 항목 | 값 |
|-----|---|
| URL | `POST https://api.bootpay.co.kr/v1/invoices` |
| 인증 | `Authorization: Bearer {access_token}` |
| Content-Type | `application/json` |

#### 요청 파라미터

| 파라미터 | 필수 | 설명 |
|---------|-----|-----|
| request_id | **O** | **SDK와 매칭할 고유 ID** |
| name | O | 청구서 이름 |
| price | O | 총 금액 |
| user | O | 사용자 정보 |
| products | O | 상품 목록 (할인 정보 포함) |
| redirect_url | - | 결제 완료 후 이동 URL |
| webhook_url | - | Webhook 수신 URL |
| metadata | - | 사업자 커스텀 데이터 |

#### user 구조

| 파라미터 | 설명 |
|---------|-----|
| user_id | 사업자측 사용자 ID |
| name | 사용자 이름 |
| phone | 전화번호 |
| email | 이메일 |
| membership_type | 회원 유형 |

#### products 구조

| 파라미터 | 설명 |
|---------|-----|
| product_id | 상품 ID |
| product_option_id | 상품 옵션 ID |
| duration | 구독 기간 (개월) |
| quantity | 수량 |
| price_adjustments | **할인/추가비용 설정** |

#### price_adjustments 구조 (핵심)

| 파라미터 | 설명 |
|---------|-----|
| price_adjustment_id | 조정 ID |
| name | 조정 이름 |
| start_at | 적용 시작일 |
| end_at | 적용 종료일 |
| cycles | 주기별 조정 목록 |

#### cycles 구조

| 파라미터 | 설명 |
|---------|-----|
| duration | 적용 기간 (개월) |
| adjustment_type | 조정 유형 |
| name | 조정 이름 |
| value | 조정 값 |
| min_value | 최소값 (할인율 적용 시) |
| max_value | 최대값 (할인율 적용 시) |

#### adjustment_type 종류

| 유형 | 설명 | value 의미 |
|-----|-----|-----------|
| `discount_percent` | 퍼센트 할인 | 할인율 (%) |
| `discount_price` | 금액 할인 | 할인 금액 (원) |
| `setup_fee` | 도입비/설치비 | 추가 금액 (원) |

---

### Step 2: 클라이언트 SDK 호출

**서버에서 사용한 동일한 request_id로 호출**

#### SDK 메서드

| 메서드 | 필수 입력 |
|-------|----------|
| `BootpayCommerce.requestInvoice()` | request_id |

#### SDK 응답

| 파라미터 | 설명 |
|---------|-----|
| receipt_id | 영수증 ID |
| order_id | 주문 ID |
| status | 결제 상태 |
| price | 결제 금액 |

---

## 4. 할인 적용 예시

### 시나리오

| 조건 | 값 |
|-----|---|
| 상품 | Pro 플랜 |
| 기간 | 24개월 |
| 프로모션 | 첫 구매 할인 |

### 할인 구조

| 기간 | 조정 유형 | 내용 |
|-----|----------|-----|
| 1개월차 | `discount_percent` | 20% 할인 (최소 100원, 최대 500원) |
| 2-3개월차 | `discount_price` | 100원 할인 |
| 최초 1회 | `setup_fee` | 도입비 500원 추가 |

### 월별 결제 금액 (기본가 10,000원 가정)

| 월 | 계산 | 결제 금액 |
|---|-----|----------|
| 1개월 | 10,000 - 500(20% 할인, max 적용) + 500(도입비) | 10,000원 |
| 2개월 | 10,000 - 100 | 9,900원 |
| 3개월 | 10,000 - 100 | 9,900원 |
| 4개월~ | 10,000 | 10,000원 |

---

## 5. 보안 체크리스트

### 클라이언트에서 절대 받지 말 것

| 항목 | 이유 |
|-----|-----|
| price | 가격 위변조 가능 |
| discount_percent | 할인율 위변조 가능 |
| discount_price | 할인 금액 위변조 가능 |
| price_adjustments | 전체 할인 구조 위변조 가능 |

### 클라이언트에서 받아도 되는 것

| 항목 | 이유 |
|-----|-----|
| request_id | 서버에서 생성한 청구서와 매칭용 |

---

## 6. API 엔드포인트 정리

| 메서드 | 경로 | 용도 |
|-------|-----|-----|
| `POST` | `/v1/invoices` | 청구서 생성 |
| `GET` | `/v1/invoices` | 청구서 목록 조회 |
| `GET` | `/v1/invoices/:id` | 청구서 단건 조회 |
| `POST` | `/v1/invoices/:id/notify` | 알림 발송 |

---

## 7. SDK 메서드

| 메서드 | 용도 |
|-------|-----|
| `BootpayCommerce.requestInvoice()` | 청구서 결제 |

### 호출 방식

| 방식 | 입력 | 사용 시점 |
|-----|-----|----------|
| 직접 호출 | 전체 파라미터 | 할인 없는 고정 가격 |
| request_id 매칭 | request_id만 | **할인/프로모션 적용 시** |

---

## 8. 전체 요약

### 흐름

```
① 사업자 서버 → 부트페이 API: 청구서 생성 (request_id + 할인 포함)
② 클라이언트 SDK: requestInvoice({ request_id }) 호출
③ 부트페이: request_id로 매칭 → 할인 적용된 결제 진행
④ 결제 완료 → 클라이언트에 결과 반환
⑤ 부트페이 → 사업자 서버: Webhook 전송
```

### 책임 분리

| 역할 | 담당 |
|-----|-----|
| 할인 로직/검증 | 사업자 서버 |
| 청구서 생성 | 부트페이 API |
| request_id 매칭 | 부트페이 |
| 결제 UI/처리 | 부트페이 SDK |
| 정기 결제 | 부트페이 서버 |
| 결과 알림 | 부트페이 Webhook |

### 핵심 원칙

```
┌─────────────────────────────────────────────────────────┐
│  할인 파라미터는 서버 API에서 설정                        │
│  클라이언트는 request_id만 전달하여 매칭                  │
└─────────────────────────────────────────────────────────┘
```
